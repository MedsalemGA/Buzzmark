
<div class="flex h-screen bg-gray-100">
  <!-- Panneau gauche : Liste des conversations -->
  <div class="w-full md:w-1/3 bg-white text-gray-800 border-r border-gray-200 overflow-y-auto rounded-r-xl shadow-sm md:block" [class.hidden]="!showConversationList">
    <!-- En-tête avec logo et titre -->
    <div class="p-4 bg-blue-600 text-white flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://via.placeholder.com/40" alt="Logo Messagerie" class="w-10 h-10 rounded-full">
        <h2 class="text-xl font-bold">Messagerie</h2>
      </div>
      <button class="text-white hover:bg-blue-700 p-2 rounded-full" [attr.aria-label]="'Nouvelle conversation'" (click)="startNewConversation()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
      </button>
    </div>
    <!-- Barre de recherche -->
    <div class="p-4 relative">
      <input type="text" 
             [(ngModel)]="searchQuery" 
             (ngModelChange)="filterConversations()"
             placeholder="Rechercher un utilisateur..." 
             class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
             [attr.aria-label]="'Rechercher une conversation'">
      <svg class="w-5 h-5 text-gray-400 absolute left-6 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </div>
    <!-- Liste des conversations -->
    <div class="divide-y divide-gray-200" role="list" [attr.aria-label]="'Liste des conversations'">
      <div *ngFor="let conversation of filteredConversations" 
           (click)="selectConversation(conversation)"
           class="p-4 flex items-center cursor-pointer hover:bg-gray-100 transition"
           [class.bg-blue-100]="selectedConversation?.id === conversation.id"
           role="listitem"
           tabindex="0"
           (keyup.enter)="selectConversation(conversation)">
        <div class="relative">
          <img [src]="conversation.imageUrl || 'https://via.placeholder.com/40'" 
               [attr.alt]="'Photo de profil de ' + conversation.name" 
               class="w-10 h-10 rounded-full object-cover">
          <span *ngIf="conversation.isOnline" 
                class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"
                [attr.aria-label]="conversation.name + ' est en ligne'"></span>
        </div>
        <div class="ml-3 flex-1">
          <div class="flex justify-between">
            <p class="font-semibold">{{ conversation.name }}</p>
            <span class="text-xs text-gray-500">{{ conversation.lastMessageTimestamp | date:'shortTime' }}</span>
          </div>
          <p class="text-sm text-gray-600 truncate">{{ conversation.lastMessage }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Panneau droit : Zone de discussion -->
  <div class="flex-1 flex flex-col">

    <!-- En-tête de la conversation -->
    <div *ngIf="selectedConversation" class="p-4 bg-white border-b border-gray-200 flex items-center justify-between rounded-b-xl">
      <!-- Message d'accueil quand aucune conversation n'est sélectionnée -->
<div *ngIf="!selectedConversation" class="flex-1 flex items-center justify-center bg-gray-50 p-4">
  <h1 class="text-4xl sm:text-5xl font-bold text-center">
    <span class="text-orange-500">Buzzmark</span>
    <span class="text-sky-400">Chat</span>
  </h1>
</div>

      <div class="flex items-center gap-2">
        <button class="md:hidden text-gray-600 hover:text-gray-800 p-2" (click)="showConversationList = true" [attr.aria-label]="'Retour à la liste des conversations'">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <img [src]="selectedConversation?.imageUrl || 'https://via.placeholder.com/40'" 
             [attr.alt]="'Photo de profil de ' + selectedConversation?.name" 
             class="w-8 h-8 rounded-full object-cover mr-2">
        <h3 class="text-lg font-semibold">{{ selectedConversation?.name }}</h3>
        <span *ngIf="selectedConversation?.isOnline" 
              class="w-3 h-3 bg-green-500 rounded-full" 
              [attr.aria-label]="selectedConversation?.name + ' est en ligne'"></span>
      </div>
      <div class="flex gap-2">
        <button class="text-gray-600 hover:text-blue-600 p-2" [attr.aria-label]="'Appel audio'" (click)="startAudioCall()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.7.3l7 7a2 2 0 010 2.83l-7 7a1 1 0 01-.7.3H5a2 2 0 01-2-2V5z"/>
          </svg>
        </button>
        <button class="text-gray-600 hover:text-blue-600 p-2" [attr.aria-label]="'Appel vidéo'" (click)="startVideoCall()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.5 4.5m0 0l-4.5 4.5m4.5-4.5H5"/>
          </svg>
        </button>
        <button class="text-gray-600 hover:text-blue-600 p-2" [attr.aria-label]="'Informations sur la conversation'" (click)="showConversationInfo()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div class="flex-1 p-4 overflow-y-auto bg-gray-50 relative" #messageContainer (click)="hideContextMenu()">
      <!-- Indicateur de saisie -->
      <div *ngIf="isTyping" class="mb-4 flex">
        <div class="max-w-xs p-3 rounded-2xl bg-gray-200 text-gray-800 relative">
          <div class="flex gap-1">
            <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></span>
            <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-100"></span>
            <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-200"></span>
          </div>
          <div class="absolute -bottom-2 left-3 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-gray-200"></div>
        </div>
      </div>
      <!-- Messages -->
      <ng-container *ngIf="selectedConversation">
        <ng-container *ngFor="let message of selectedConversation?.messages; let i = index; let first = first; let last = last">
          <div class="mb-1 flex"
               [class.justify-end]="message.isSentByMe"
               (contextmenu)="showContextMenu($event, i, $event.target)">
            <div class="max-w-xs sm:max-w-md p-3 rounded-2xl shadow-sm relative"
                 [class.bg-blue-600]="message.isSentByMe"
                 [class.text-white]="message.isSentByMe"
                 [class.bg-white]="!message.isSentByMe"
                 [class.text-gray-800]="!message.isSentByMe"
                 [class.border]="!message.isSentByMe"
                 [class.border-gray-200]="!message.isSentByMe"
                 [class.mt-1]="!first && selectedConversation.messages[i-1]?.isSentByMe === message.isSentByMe"
                 [class.rounded-tl-sm]="message.isSentByMe && !last"
                 [class.rounded-tr-sm]="!message.isSentByMe && !last"
                 [class.rounded-tl-2xl]="message.isSentByMe && last"
                 [class.rounded-tr-2xl]="!message.isSentByMe && last">
              <p>{{ message.content }}</p>
              <div class="flex justify-between items-center mt-1">
                <p class="text-xs opacity-70">{{ message.timestamp | date:'shortTime' }}</p>
                <span *ngIf="message.isSentByMe && message.status" 
                      class="text-xs"
                      [class.text-blue-400]="message.status === 'read'"
                      [class.text-gray-400]="message.status === 'delivered'">
                  {{ message.status === 'read' ? 'Vu' : 'Envoyé' }}
                </span>
              </div>
              <div class="absolute -bottom-2"
                   [class.right-3]="message.isSentByMe"
                   [class.left-3]="!message.isSentByMe">
                <div class="w-0 h-0"
                     [class.border-l-8]="message.isSentByMe"
                     [class.border-r-8]="!message.isSentByMe"
                     [class.border-t-8]="true"
                     [class.border-l-transparent]="message.isSentByMe"
                     [class.border-r-transparent]="!message.isSentByMe"
                     [class.border-t-blue-600]="message.isSentByMe"
                     [class.border-t-gray-200]="!message.isSentByMe"></div>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
      <!-- Menu contextuel -->
      <div *ngIf="showMenu" 
           class="absolute bg-white shadow-lg rounded-lg py-2 w-48 z-10"
           [style.top.px]="contextMenuY"
           [style.left.px]="contextMenuX"
           role="menu"
           [attr.aria-label]="'Menu contextuel du message'">
        <div class="px-4 py-2 text-red-600 font-semibold hover:bg-gray-100 cursor-pointer"
             (click)="deleteMessage(selectedMessageIndex)"
             role="menuitem">
          Retirer le message
        </div>
        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer"
             (click)="copyMessage(selectedMessageIndex)"
             role="menuitem">
          Copier le message
        </div>
        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer"
             (click)="forwardMessage(selectedMessageIndex)"
             role="menuitem">
          Envoyer le message
        </div>
      </div>
    </div>

    <!-- Champ d'envoi -->
    <div *ngIf="selectedConversation" class="p-4 bg-white border-t border-gray-200 rounded-t-xl">
      <form (ngSubmit)="sendMessage()" class="flex gap-2 items-center">
        <button type="button" class="text-gray-600 hover:text-blue-600 p-2" [attr.aria-label]="'Ajouter une pièce jointe'" (click)="addAttachment()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 002.828 2.828l6.586-6.586a4 4 0 00-5.656-5.656l-6.586 6.586a6 6 0 008.485 8.485l6.586-6.586"/>
          </svg>
        </button>
        <button type="button" class="text-gray-600 hover:text-blue-600 p-2" [attr.aria-label]="'Ajouter un emoji'" (click)="openEmojiPicker()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </button>
        <input type="text" 
               [(ngModel)]="newMessage" 
               name="newMessage"
               placeholder="Écrivez un message..." 
               class="flex-1 p-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
               [attr.aria-label]="'Écrire un message'"
               (input)="onMessageInput()">
        <button type="submit" 
                class="text-blue-600 hover:text-blue-800 p-2" 
                [disabled]="!newMessage.trim()"
                [attr.aria-label]="'Envoyer le message'">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>